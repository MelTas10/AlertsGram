<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <img src="telegram-logo.png" alt="Telegram">
                <h2>Telegram Web</h2>
            </div>
            <div id="accountLoginStep">
                <input type="text" class="login-input" id="usernameInput" placeholder="Username">
                <input type="password" class="login-input" id="passwordInput" placeholder="Password">
                <button class="login-button" onclick="loginWithAccountCredentials()">Login with Account</button>
                <div style="text-align: center; margin: 15px 0; color: white;">or</div>
                <button class="login-button" style="background: var(--secondary);" onclick="showPhoneLogin()">Login with Phone</button>
            </div>
            <div id="phoneStep" style="display: none;">
                <input type="tel" class="login-input" id="phoneInput" placeholder="+1234567890">
                <button class="login-button" onclick="requestTelegramCode()">Send Code</button>
                <button class="login-button" style="background: var(--secondary); margin-top: 10px;" onclick="showAccountLogin()">Back to Account Login</button>
            </div>
            <div id="codeStep" class="verification-container" style="display: none;">
                <input type="text" class="login-input" id="codeInput" placeholder="Enter code from Telegram">
                <button class="login-button" onclick="verifyTelegramCode()">Verify</button>
                <div id="loading" class="loading-spinner" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar"></div>
                    <div class="user-name"></div>
                </div>
            </div>
            <div class="search-box">
                <input type="text" placeholder="Search..." onkeyup="searchChats(this.value)">
            </div>
            <div class="chat-list" id="chatList"></div>
        </div>
        <div class="message-area">
            <div class="chat-header">
                <div class="chat-info">
                    <div class="chat-title"></div>
                    <div class="chat-status"></div>
                </div>
                <div class="chat-actions">
                    <button class="action-button" onclick="toggleChatInfo()">
                        <i class="info-icon"></i>
                    </button>
                </div>
            </div>
            <div class="messages-container" id="messagesContainer"></div>
            <div class="message-input">
                <button class="attachment-button">
                    <i class="attachment-icon"></i>
                </button>
                <input type="text" id="messageInput" placeholder="Type a message...">
                <button class="send-button" onclick="sendMessage()">
                    <i class="send-icon"></i>
                </button>
            </div>
        </div>
        <div class="chat-info-panel" id="chatInfoPanel">
            <!-- Chat info content -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore.js"></script>
    
    <!-- Telegram Web App JS -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Main App JavaScript -->
    <script src="app.js"></script>
</body>
</html>

// Конфигурация Firebase
const firebaseConfig = {
    apiKey: "your-api-key",
    authDomain: "your-domain.firebaseapp.com",
    projectId: "your-project-id",
    storageBucket: "your-bucket.appspot.com",
    messagingSenderId: "your-sender-id",
    appId: "your-app-id"
};

// Инициализация Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Telegram API конфигурация
const telegramBotToken = '7893025918:AAEZCxvHKXpsiKc1NHbMg7h0hTMvLg34Nlg';
const telegramApiUrl = `https://api.telegram.org/bot${telegramBotToken}`;

// Глобальные переменные
let currentUser = null;
let currentChat = null;
let ws = null;
let messageQueue = [];
let isReconnecting = false;

// Функции аутентификации
async function loginWithAccountCredentials() {
    const username = document.getElementById('usernameInput').value;
    const password = document.getElementById('passwordInput').value;
    
    try {
        const userCredential = await auth.signInWithEmailAndPassword(username, password);
        currentUser = userCredential.user;
        initializeApp();
    } catch (error) {
        handleAuthError(error);
    }
}

function showPhoneLogin() {
    document.getElementById('accountLoginStep').style.display = 'none';
    document.getElementById('phoneStep').style.display = 'block';
}

function showAccountLogin() {
    document.getElementById('phoneStep').style.display = 'none';
    document.getElementById('accountLoginStep').style.display = 'block';
}

async function requestTelegramCode() {
    const phone = document.getElementById('phoneInput').value;
    try {
        document.getElementById('loading').style.display = 'block';
        
        const response = await fetch(`${telegramApiUrl}/auth/sendCode`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone_number: phone,
                settings: {
                    type: 'application/json'
                }
            })
        });

        const data = await response.json();
        
        if (data.ok) {
            document.getElementById('phoneStep').style.display = 'none';
            document.getElementById('codeStep').style.display = 'block';
            localStorage.setItem('phoneHash', data.result.phone_code_hash);
        }
    } catch (error) {
        handleAuthError(error);
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

async function verifyTelegramCode() {
    const code = document.getElementById('codeInput').value;
    const phone = document.getElementById('phoneInput').value;
    const phoneHash = localStorage.getItem('phoneHash');

    try {
        document.getElementById('loading').style.display = 'block';

        const response = await fetch(`${telegramApiUrl}/auth/signIn`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone_number: phone,
                phone_code_hash: phoneHash,
                phone_code: code
            })
        });

        const data = await response.json();

        if (data.ok) {
            currentUser = data.result.user;
            localStorage.setItem('telegramUser', JSON.stringify(currentUser));
            initializeApp();
        }
    } catch (error) {
        handleAuthError(error);
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

// Инициализация приложения
function initializeApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'flex';
    
    initializeWebSocket();
    loadUserData();
    setupEventListeners();
}

// WebSocket функции
function initializeWebSocket() {
    ws = new WebSocket('wss://your-websocket-server.com');
    
    ws.onopen = handleWebSocketOpen;
    ws.onmessage = handleWebSocketMessage;
    ws.onerror = handleWebSocketError;
    ws.onclose = handleWebSocketClose;
}

function handleWebSocketOpen() {
    console.log('WebSocket Connected');
    isReconnecting = false;
    
    // Отправка накопленных сообщений
    while (messageQueue.length > 0) {
        const message = messageQueue.shift();
        sendMessage(message);
    }
}

function handleWebSocketMessage(event) {
    const message = JSON.parse(event.data);
    handleNewMessage(message);
}

function handleWebSocketError(error) {
    console.error('WebSocket Error:', error);
}

function handleWebSocketClose() {
    console.log('WebSocket Disconnected');
    if (!isReconnecting) {
        isReconnecting = true;
        setTimeout(initializeWebSocket, 1000);
    }
}

// Функции работы с данными
async function loadUserData() {
    try {
        const chatsSnapshot = await db.collection('chats')
            .where('participants', 'array-contains', currentUser.id)
            .get();

        const chats = [];
        chatsSnapshot.forEach(doc => {
            chats.push({
                id: doc.id,
                ...doc.data()
            });
        });

        renderChats(chats);
    } catch (error) {
        console.error('Error loading user data:', error);
    }
}

async function loadChatMessages(chatId) {
    try {
        const messagesSnapshot = await db.collection('messages')
            .where('chatId', '==', chatId)
            .orderBy('timestamp')
            .limit(50)
            .get();

        const messages = [];
        messagesSnapshot.forEach(doc => {
            messages.push({
                id: doc.id,
                ...doc.data()
            });
        });

        renderMessages(messages);
    } catch (error) {
        console.error('Error loading chat messages:', error);
    }
}

// UI функции
function renderChats(chats) {
    const chatList = document.getElementById('chatList');
    chatList.innerHTML = '';

    chats.forEach(chat => {
        const chatElement = createChatElement(chat);
        chatList.appendChild(chatElement);
    });
}

function createChatElement(chat) {
    const div = document.createElement('div');
    div.className = 'chat-item';
    div.innerHTML = `
        <div class="chat-avatar"></div>
        <div class="chat-info">
            <div class="chat-name">${chat.name}</div>
            <div class="chat-preview">${chat.lastMessage?.text || ''}</div>
        </div>
    `;
    
    div.onclick = () => openChat(chat);
    
    return div;
}

function renderMessages(messages) {
    const container = document.getElementById('messagesContainer');
    container.innerHTML = '';

    messages.forEach(message => {
        const messageElement = createMessageElement(message);
        container.appendChild(messageElement);
    });

    container.scrollTop = container.scrollHeight;
}

function createMessageElement(message) {
    const div = document.createElement('div');
    div.className = `message ${message.senderId === currentUser.id ? 'sent' : 'received'}`;
    div.textContent = message.text;
    return div;
}

// Обработчики событий
function setupEventListeners() {
    const messageInput = document.getElementById('messageInput');
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Добавление других обработчиков событий
}

async function sendMessage(text = document.getElementById('messageInput').value.trim()) {
    if (!text || !currentChat) return;

    const message = {
        chatId: currentChat.id,
        text: text,
        senderId: currentUser.id,
        timestamp: new Date()
    };

    try {
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(message));
        } else {
            messageQueue.push(message);
        }

        await db.collection('messages').add(message);
        document.getElementById('messageInput').value = '';
        
        handleNewMessage({
            ...message,
            fromSelf: true
        });
    } catch (error) {
        console.error('Error sending message:', error);
    }
}

// Вспомогательные функции
function handleAuthError(error) {
    console.error('Auth Error:', error);
    alert('Authentication failed. Please try again.');
}

function handleNewMessage(message) {
    if (message.chatId === currentChat?.id) {
        const messageElement = createMessageElement(message);
        document.getElementById('messagesContainer').appendChild(messageElement);
    }
    updateChatPreview(message);
}

function updateChatPreview(message) {
    const chatElement = document.querySelector(`[data-chat-id="${message.chatId}"]`);
    if (chatElement) {
        const previewElement = chatElement.querySelector('.chat-preview');
        previewElement.textContent = message.text;
    }
}

function searchChats(query) {
    const chatElements = document.querySelectorAll('.chat-item');
    chatElements.forEach(element => {
        const chatName = element.querySelector('.chat-name').textContent.toLowerCase();
        element.style.display = chatName.includes(query.toLowerCase()) ? 'flex' : 'none';
    });
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    const savedUser = localStorage.getItem('telegramUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        initializeApp();
    }
});
